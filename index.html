<script>
  // Fonction pour afficher les informations des animes
  function displayAnime(data) {
    const animeList = document.getElementById("anime-list");
    animeList.innerHTML = ""; // Clear the existing list

    data.forEach(anime => {
      const aVoir = anime.episodes_dispo - anime.episodes_vus;
      const prochain = anime.episodes_vus + 1;
      const lien = `https://v6.voiranime.com/anime/${anime.slug}/${anime.slug}-${String(prochain).padStart(2, '0')}-vostfr/`;

      const card = document.createElement("div");
      card.className = "bg-gray-800 rounded-2xl shadow-md p-4 flex flex-col md:flex-row items-start space-x-4 anime-card";
      card.setAttribute("data-slug", anime.slug);
      card.setAttribute("data-episodes-dispo", anime.episodes_dispo);

      // VÃ©rifier si les Ã©pisodes sont Ã  jour pour dÃ©sactiver le bouton
      const isEpisodesUpToDate = anime.episodes_vus === anime.episodes_dispo;

      card.innerHTML = `
        <div class="flex-shrink-0">
          <img src="${anime.image_url}" alt="${anime.titre}" onerror="this.src='fallback.jpg'" class="w-32 h-48 object-cover mb-4 md:mb-0">
        </div>
        <div class="flex flex-col justify-start">
          <h2 class="text-xl font-semibold mb-2">${anime.titre}</h2>
          <p class="mb-1">ðŸ“¼ Total d'Ã©pisodes : ${anime.nb_episode}</p>
          <p class="mb-1 episodes-vus">ðŸŽ¬ VisionnÃ©s : ${anime.episodes_vus}</p>
          <p class="mb-1">ðŸ“º Sortis : ${anime.episodes_dispo}</p>
          <p class="mb-2 a-voir">ðŸ”¥ Ã€ voir : ${aVoir} Ã©pisode${aVoir > 1 ? 's' : ''}</p>
          <a href="${lien}" target="_blank" class="w-48 text-center bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 transition ${aVoir === 0 ? 'cursor-not-allowed bg-gray-600' : ''}" ${aVoir === 0 ? 'disabled' : ''}>
            ${aVoir === 0 ? 'Ã€ jour' : `Regarder Ã©pisode ${prochain}`}
          </a>
          <button onclick="updateEpisodes('${anime.titre}', ${anime.episodes_vus}, this)" class="mt-2 bg-green-500 text-white px-4 py-2 rounded-xl hover:bg-green-600 transition ${isEpisodesUpToDate ? 'bg-gray-600 cursor-not-allowed' : ''}" ${isEpisodesUpToDate ? 'disabled' : ''}>
            ${isEpisodesUpToDate ? 'Ã‰pisodes Ã  jour' : 'Mettre Ã  jour les Ã©pisodes'}
          </button>
          <p class="mt-2 text-sm text-green-500 success-message hidden">Ã‰pisodes mis Ã  jour avec succÃ¨s !</p>
          <p class="mt-2 text-sm text-red-500 error-message hidden">Erreur lors de la mise Ã  jour.</p>
        </div>
      `;
      animeList.appendChild(card);
    });
  }

  // Fonction pour mettre Ã  jour les Ã©pisodes
  function updateEpisodes(titre, episodes_vus, button) {
    const newEpisodesVus = episodes_vus + 1; // Ajouter 1 Ã©pisode vu

    const cacheBuster = new Date().getTime();

    // Envoi de la requÃªte GET Ã  l'URL de mise Ã  jour
    fetch(`${updateUrl}?titre=${encodeURIComponent(titre)}&episodes_vus=${newEpisodesVus}&cache_buster=${cacheBuster}`)
      .then(response => response.json())
      .then(data => {
        const successMessage = button.parentElement.querySelector(".success-message");
        const errorMessage = button.parentElement.querySelector(".error-message");

        if (data.success) {
          successMessage.classList.remove("hidden");
          errorMessage.classList.add("hidden");

          // Mise Ã  jour de l'affichage sans recharger la page
          updateAnimeInList(titre, newEpisodesVus);

          // Masquer le message aprÃ¨s quelques secondes
          setTimeout(() => {
            successMessage.classList.add("hidden");
          }, 3000);
        } else {
          successMessage.classList.add("hidden");
          errorMessage.classList.remove("hidden");
        }
      })
      .catch(err => {
        const successMessage = button.parentElement.querySelector(".success-message");
        const errorMessage = button.parentElement.querySelector(".error-message");

        successMessage.classList.add("hidden");
        errorMessage.classList.remove("hidden");

        console.error(err);
      });
  }

  // Fonction pour mettre Ã  jour les donnÃ©es d'un anime spÃ©cifique dans la liste
  function updateAnimeInList(titre, newEpisodesVus) {
    const animeList = document.getElementById("anime-list");
    const animeCards = animeList.getElementsByClassName("anime-card");

    // Trouver l'anime correspondant dans la liste
    for (let card of animeCards) {
      const animeTitle = card.querySelector("h2").textContent;

      if (animeTitle === titre) {
        const episodesVusElement = card.querySelector(".episodes-vus");
        const aVoirElement = card.querySelector(".a-voir");
        const lienElement = card.querySelector("a");
        const buttonElement = card.querySelector("button");

        // Mettre Ã  jour l'affichage des Ã©pisodes vus et Ã  voir
        const episodes_vus = newEpisodesVus;
        const episodes_dispo = parseInt(card.getAttribute("data-episodes-dispo"));
        const aVoir = episodes_dispo - episodes_vus;

        episodesVusElement.textContent = `ðŸŽ¬ VisionnÃ©s : ${episodes_vus}`;
        aVoirElement.textContent = `ðŸ”¥ Ã€ voir : ${aVoir} Ã©pisode${aVoir > 1 ? 's' : ''}`;

        // Mise Ã  jour du lien de l'Ã©pisode suivant
        const prochain = episodes_vus + 1;
        const slug = card.getAttribute("data-slug");
        const lien = `https://v6.voiranime.com/anime/${slug}/${slug}-${String(prochain).padStart(2, '0')}-vostfr/`;
        lienElement.href = lien;
        lienElement.textContent = aVoir === 0 ? 'Ã€ jour' : `Regarder Ã©pisode ${prochain}`;
        lienElement.classList.toggle("cursor-not-allowed", aVoir === 0);
        lienElement.classList.toggle("bg-gray-600", aVoir === 0);

        // DÃ©sactivation du bouton si les Ã©pisodes sont Ã  jour
        const isEpisodesUpToDate = episodes_vus === episodes_dispo;
        buttonElement.classList.toggle("bg-gray-600", isEpisodesUpToDate);
        buttonElement.classList.toggle("cursor-not-allowed", isEpisodesUpToDate);
        buttonElement.disabled = isEpisodesUpToDate;

        break;
      }
    }
  }
</script>



